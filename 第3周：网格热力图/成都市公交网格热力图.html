<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成都市公交网格热力图</title>
    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* 标题容器 */
        .demo-title {
            position: absolute;
            top: 25px;
            left: 25px;
            z-index: 1;
        }

        /* 主标题 */
        h1 {
            font-size: 18px;
            margin: 0;
            color: rgb(180, 180, 190);
        }

        /* 副标题 */
        h3 {
            font-size: 12px;
            font-weight: normal;
            margin-top: 5px;
            color: rgb(150,150,150);
        }
    </style>
</head>

<body>
    <!-- 调用标题容器和标题格式 -->
    <div class="demo-title">
        <h1>网格图--成都市公交密度热力图</h1>
        <h3>通过热力映射公交车辆分布情况，颜色和高度体现出车辆密度</h3>
    </div>

    <!-- 地图容器 -->
    <div id="map"></div>
    <!-- 引入高德地图和Loca.js -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=0aafc83cbd2990a6566e3c1f99020ce5"></script>
    <script src="https://webapi.amap.com/loca?v=2.0.0&key=0aafc83cbd2990a6566e3c1f99020ce5"></script>
    <script src="data/cd_bus_o_heat.js"></script>

    <script>
      var map = new AMap.Map('map', {
         zoom: 11.57,                    // 缩放级别
         center: [104.065767,30.65744],  // 成都市中心坐标
         // showLabel: false,
         pitch: 45,                      // 3D俯仰角度（倾斜45度）
         rotation: -163,                 // 地图旋转角度
         viewMode: '3D',                 // 3D模式
         showLabel: false,               // 隐藏标签
         mapStyle: 'amap://styles/dark', // 深色地图样式
      });

      // 创建Loca可视化容器
      var loca = new Loca.Container({
          map,
      });
        // 创建并设置三种光照
      loca.ambLight = {
          intensity: 2.0,
          color: '#fff',
      };
      loca.dirLight = {
          intensity: 1.2,
          color: '#fff',
          target: [0, 1, 0],
          position: [0, -1, 1],
      };
      loca.pointLight = {
          color: 'rgb(100,100,100)',
          position: [114.2517, 30.552128, 20000],
          intensity: 1.6,
          // 距离表示从光源到光照强度为 0 的位置，0 就是光不会消失。
          distance: 100000,
      };

      // 数据转换过程
      let originData = heat.data;
      let geoData = {"type": "FeatureCollection",features:[]}
      originData.forEach(element=>{
          geoData.features.push({
              "type": "Feature",
              "properties": {
                  "count": element.count
              },
              "geometry": {
                  "type": "Point",
                  "coordinates": [
                      element.lng,
                      element.lat
                  ]
              }
          })
      })

      //   console.log("111111111",geoData.features[0]);
      //   console.log("3333333333333333333",geoData.features[0].geometry.coordinates);
      //   console.log("2222222222",geoData.features[0].properties.count);
      // 创建数据源
      // 这里传入的是内存中的 GeoJSON 对象，不是一个 URL 字符串，
      // 因此应使用 data 字段而不是 url。
      var geo = new Loca.GeoJSONSource({
          data: geoData,
      });
    //   console.log("检验数据传输");
    //   console.log("geo数据源:", geo);
    //   console.log("原始数据:", geo.rawData);
    //   console.log("第一个特征:", geo.features[0]);
    //   console.log("第一个特征的properties:", geo.rawData.features[0].properties); 
      // 创建网格图层
      var ll = new Loca.GridLayer({
        //   loca,
          zIndex: 10,
          opacity: 1,
          visible: true,
          zooms: [2, 22],
          acceptLight: true,
          // shinniness: 0,
          // cullface: 'none',
          // depth: true,
          // hasSide: true,
      });

      // 分级设置柱状图颜色和高度
      var colors = ['#FAE200', '#D27E37', '#C53634', '#C12B6E', '#A92E9A', '#67238A', '#211A50', '#18244E'].reverse();
      var heights = [50, 100, 200, 300, 400, 700, 900, 2000];
      ll.setSource(geo);
      ll.setStyle({
          unit: 'meter',
          radius:66,
          gap: 0,
          altitude: 100,
          height: function (index, feature) {
              var val =  feature.coordinates[0].properties.count || 0;
              console.log("111111111",feature);
            //   console.log("33333333",feature.coordinates[0].properties.count);
            //   console.log("2222222222",val);
                return val < 5 ?
                    heights[0] : val < 10 ?
                        heights[1] : val < 20 ?
                            heights[2] : val < 30 ?
                                heights[3] : val < 50 ?
                                    heights[4] : val < 80 ?
                                        heights[5] : val < 100 ?
                                            heights[6] : heights[7];
                // return val
          },
          topColor: function (index, feature) {
              var val = feature.coordinates[0].properties.count || 0;
              return val < 5 ?
                  colors[0] : val < 10 ?
                      colors[1] : val < 20 ?
                          colors[2] : val < 30 ?
                              colors[3] : val < 50 ?
                                  colors[4] : val < 80 ?
                                      colors[5] : val < 100 ?
                                          colors[6] : colors[7];
          },
          sideTopColor: function (index, feature) {
              var val = feature.coordinates[0].properties.count || 0;
              return val < 5 ?
                  colors[0] : val < 10 ?
                      colors[1] : val < 20 ?
                          colors[2] : val < 30 ?
                              colors[3] : val < 50 ?
                                  colors[4] : val < 80 ?
                                      colors[5] : val < 100 ?
                                          colors[6] : colors[7];
          },
          sideBottomColor: function (index, feature) {
              var val = feature.coordinates[0].properties.count || 0;
              return val < 5 ?
                  colors[0] : val < 10 ?
                      colors[1] : val < 20 ?
                          colors[2] : val < 30 ?
                              colors[3] : val < 50 ?
                                  colors[4] : val < 80 ?
                                      colors[5] : val < 100 ?
                                          colors[6] : colors[7];
          }
      });
      loca.add(ll);

      // 图例
      var lengend = new Loca.Legend({
          loca: loca,
          title: {
              label: '车辆密度(辆)',
              fontColor: 'rgba(255,255,255,0.4)',
              fontSize: '16px',
          },
          style: {
              backgroundColor: 'rgba(255,255,255,0.1)',
              left: '20px',
              bottom: '40px',
              fontSize: '12px',
          },
          dataMap: [
              { label: 100, color: colors[7] },
              { label: 80, color: colors[6] },
              { label: 50, color: colors[5] },
              { label: 40, color: colors[4] },
              { label: 30, color: colors[3] },
              { label: 20, color: colors[2] },
              { label: 10, color: colors[1] },
              { label: 5, color: colors[0] },
          ],
      });

      // 控制条
      var dat = new Loca.Dat();
      dat.addLight(loca.ambLight, loca, '环境光');
      dat.addLight(loca.dirLight, loca, '平行光');
      dat.addLight(loca.pointLight, loca, '点光');
      dat.addLayer(ll, '车辆图层');

    </script>
</body>

</html>